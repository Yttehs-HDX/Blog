---
title: ç”¨è½¯ä»¶å·¥ç¨‹çš„æ€ç»´è¿›è¡Œå•ç‰‡æœºç¼–ç¨‹
date: 2025-06-09 11:22:29
tags: [Guide, Embedded, CH32]
category: [Guide, Embedded]
thumbnail: image/software-engineer-micro-program/head.webp
excerpt: è½¯ä»¶å¼€å‘è€…çš„å•ç‰‡æœºåˆä½“éªŒ
---

## å‰è¨€

å¤´åƒæ¥è‡ª [ch32-rs](https://github.com/ch32-rs).

{% notel yellow Warn %}
æœ¬æ–‡**ä¸æ˜¯**æ–°æ‰‹å…¥é—¨æ•™ç¨‹ï¼Œåªæ˜¯æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€‚
æœ¬æ–‡æåŠçš„ä»»ä½•å¼€å‘ç‰ˆã€åº“ã€å·¥å…·ä¸æœ¬äºº**æ— ä»»ä½•åˆ©ç›Šå…³ç³»**ï¼Œåªä½œä¸ºåˆ†äº«ã€‚
æ–‡ä¸­åŒ…å«äº†æˆ‘ä¸ªäººçš„ä¸»è§‚æƒ³æ³•ï¼Œ**ä¸ä¸€å®š**æ­£ç¡®ï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚
{% endnotel %}

### èµ·å› 

å®¤å‹é‚€è¯·æˆ‘æ‰“åµŒå…¥å¼æ¯”èµ›ï¼Œè®©æˆ‘è´Ÿè´£å‰ç«¯ app éƒ¨åˆ†ï¼Œåæ¥å¾—çŸ¥å¼€å‘ç‰ˆå¯ä»¥ä»ä¸»åŠæ–¹å…è´¹ç”³è¯·ï¼Œå°±æŠ±ç€ç©ä¸€ç©çš„å¿ƒæ€ç”³è¯·äº†ä¸€å— CH32V307VCT6ã€‚

![micro](micro.jpg)

### å‹˜è¯¯

åœ¨æ·±å…¥ç ”ç©¶æ–‡æœ¬ä¹‹å‰ï¼Œè¯·åŠ¡å¿…æ³¨æ„å¯èƒ½å­˜åœ¨ä¸€äº› **è¯­æ³•é”™è¯¯** ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç¿»è¯‘é”™è¯¯ã€æ‰“å­—é”™è¯¯æˆ–ä½œè€…ç‹¬ç‰¹çš„å†™ä½œé£æ ¼ã€‚

å¦‚æœä½ æœ‰ç–‘é—®æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ–é€šè¿‡é‚®ç®± shetty@shettydev.com è”ç³»ã€‚

## å¼€å‘æ¿å‚æ•°

CH32V307VCT6ï¼Œå±äº CH32 ç³»åˆ—ï¼Œå®ƒåœ¨è®¾è®¡ä¸Šä¼°è®¡æ˜¯æ¨¡ä»¿ STM32 çš„ï¼Œåªä¸è¿‡èŠ¯ç‰‡æ¶æ„æ˜¯ riscv32ã€‚

| åç§°         | ç³»åˆ— | æ¶æ„    | æ–‡æ¡£                                             |
|:------------:|:----:|:-------:|:------------------------------------------------:|
| CH32V307VCT6 | CH32 | riscv32 | [WCH](https://www.wch.cn/products/CH32V307.html) |

å®ƒæœ‰ä¸€ä¸ªæ¯”åŒç³»åˆ—ï¼ˆCH32 ç³»åˆ—ï¼‰ä¸ä¼—ä¸åŒçš„åœ°æ–¹ï¼šå¼€å‘ç‰ˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸»ä½“å’Œ W-Link ï¼ŒW-Link çš„åŠŸèƒ½æ˜¯ USB-Serial è½¬æ¢ï¼Œä¸€èˆ¬çš„æ¿å­éœ€è¦æ ¼å¤–çš„è½¬æ¢å™¨ä»¥åŠè‹¥å¹²æ ¹æœé‚¦çº¿æ‰èƒ½å¤Ÿè¿›è¡Œåˆ·å†™ç¨‹åºï¼Œç”±äº CH32V307VCT6 é›†æˆå¥½äº†ï¼Œæ‰€ä»¥åªéœ€è¦è¿æ¥ USB å³å¯ã€‚

## ä¼ ç»Ÿçš„ç¼–ç¨‹æ–¹å¼

ä»å®˜ç½‘æ‰¾æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç æ— ç–‘æ˜¯å­¦ä¹ çš„æœ€å¥½é€‰æ‹©ï¼Œä¸å‡ºæ‰€æ–™ï¼Œæ˜¯ç»å…¸çš„ C è¯­è¨€ã€‚

{% notel blue Info %}
å•ç‰‡æœºçš„æºç å¯ä»¥äº¤å‰ç¼–è¯‘ä¸º ELF æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ™®é€šç¨‹åºä¸åŒï¼Œæ™®é€šç¨‹åºå¦‚æœéœ€è¦è£¸æœºï¼ˆno_stdï¼‰è¿è¡Œï¼Œå¿…é¡»è£å‰ªç¬¦å·æˆä¸ºäºŒè¿›åˆ¶ï¼ˆbinï¼‰æ–‡ä»¶ï¼Œè€Œå•ç‰‡æœºçƒ§å½•çš„æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬çš„ hex æ–‡ä»¶ã€‚
æŸäº›ç±»å‹çš„å•ç‰‡æœºï¼Œæºç ä¸­ä¼šå­˜åœ¨ C è¯­è¨€ä¸­ä¸å­˜åœ¨çš„å…³é”®å­—ï¼Œæ¯”å¦‚ 8051 çš„ `code` å’Œ `interrupt` å…³é”®å­—ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ä¸ç®—æ ‡å‡†çš„ C è¯­è¨€ã€‚
{% endnotel %}

### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯åˆå§‹åŒ– GPIO çš„æºç ï¼š

```c
GPIO_InitTypeDef GPIO_InitStructure = {0};

RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOA, &GPIO_InitStructure);
```

> æœ¬äººä¸æ˜¯å¾ˆä¹ æƒ¯ do_something(&type instance, params) çš„æ–¹å¼ç”¨äºè¡¨ç¤ºä¸€ä¸ªå®ä¾‹åšäº†ä¸€ä»¶äº‹ï¼Œæ›´å–œæ¬¢ä½¿ç”¨æˆå‘˜å‡½æ•°ï¼Œinstance.do_something(params)ã€‚
> ç”±äº C è¯­è¨€çš„å±€é™æ€§ï¼Œå¾ˆå¤šåœ°æ–¹ä¹Ÿåªèƒ½è¿™æ ·åšã€‚
> ç”¨ä¸€é—¨è¯­è¨€ï¼Œå°±éµå¾ªè¿™é—¨è¯­è¨€çš„è§„èŒƒã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ä¸ªç³»åˆ—æœ‰ä¼˜ç§€çš„æ—¥å¿—åŠŸèƒ½ **SDI_Printf**ï¼Œå¯ä»¥è°ƒç”¨ printf å‡½æ•°ç›´æ¥æŠŠæ—¥å¿—æ‰“å°åˆ°ä¸²å£ï¼Œåœ¨ PC ç«¯ç›´æ¥æŸ¥çœ‹ï¼š

```c
#if (SDI_PRINT == SDI_PR_OPEN)
    SDI_Printf_Enable();
#else
    USART_Printf_Init(115200);
#endif
    printf("SystemClk:%d\r\n", SystemCoreClock);
```

## ä¸€ç§æ¯”è¾ƒæ–°çš„æ–¹å¼

### èƒŒæ™¯

å¤§åé¼é¼çš„ STM32 å­˜åœ¨å®˜æ–¹ç»´æŠ¤çš„ HAL åº“ï¼Œå°†ç¡¬ä»¶å±‚æŠ½è±¡ï¼Œä¸ºå•ç‰‡æœºç¼–ç¨‹äººå‘˜æä¾›æ¥å£ã€‚

[embassy](https://embassy.dev/) crate æä¾›äº†å®Œå–„çš„æŠ½è±¡å±‚ï¼Œè¶Šæ¥è¶Šå¤šå¼€æºç¤¾åŒºå¯¹å„ç§å¼€å‘æ¿è¿›è¡Œäº†é€‚é…ï¼Œå¾ˆå¤šä¸‰æ–¹å®ç°çš„ HAL åº“çº·çº·é—®ä¸–ï¼Œä½¿ç”¨ rust è¿›è¡ŒåµŒå…¥å¼å¼€å‘æˆä¸ºæ½®æµã€‚

### å¯¹æ¯”

ä¼ ç»Ÿå•ç‰‡æœºç¼–ç¨‹ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯é›†æˆ IDE æˆ–è€…ç¥–ä¼ çš„ Keilï¼Œæ¡†æ¶éšè—äº†ç¼–è¯‘æ‰€éœ€çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ ld è„šæœ¬ï¼‰ï¼Œéšè—äº†ç¼–è¯‘çš„å¤æ‚æµç¨‹ï¼ˆC è¯­è¨€ -> ELF -> hexï¼‰ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå¼€å‘è€…åªèƒ½åœ¨å¯¹åº”çš„ IDE ä¸­ç¼–ç¨‹ã€‚

PlatformIOã€Rust Embedded æä¾›äº† CLIï¼Œå®Œæˆå•ç‰‡æœºé¡¹ç›®å¯ä»¥ä¸ç”¨ä¾èµ–å…·ä½“çš„ IDEï¼ˆè¿™é€šå¸¸æ¯”è¾ƒéš¾ç”¨ï¼‰ã€‚å› æ­¤ï¼Œå¼€å‘è€…å¯ä»¥è‡ªç”±é€‰æ‹©å¼€å‘ç¯å¢ƒï¼Œå°†è½¯ä»¶å·¥ç¨‹çš„æœ‰ç‚¹ç§»æ¤åˆ°å•ç‰‡æœºå¼€å‘ä¸­ã€‚

### ch32-hal

[ch32-hal](https://github.com/ch32-rs/ch32-hal) æ˜¯ [ch32-rs](https://github.com/ch32-rs) ç»„ç»‡çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸ºå¤§éƒ¨åˆ† CH32 å¼€å‘æ¿æä¾›äº† HAL çš„æŠ½è±¡å±‚ï¼Œä½¿ç”¨ Rustï¼ˆno_stdï¼‰ç¼–å†™ã€‚

> ååˆ†æ„Ÿè°¢å¼€æºç¤¾åŒºæä¾›äº†è¿™ä¹ˆå¥½ç”¨çš„åº“ğŸ˜‹ã€‚

{% notel blue Info %}
Rust æ˜¯ç°ä»£çš„é«˜çº§è¯­è¨€ï¼Œç”Ÿæ€ä½æœ€å¼€å§‹ä¸ Cã€æ±‡ç¼–ç›¸åŒï¼Œä½†æ˜¯åœ¨ä»Šå¤©å·²ç»æ¶‰åŠåˆ°å„ç§é¢†åŸŸï¼šå‰ç«¯ã€åç«¯ã€åº•å±‚ç­‰ã€‚
Rust çš„ cargo åŒ…ç®¡ç†ä»¥åŠä¸°å¯Œçš„ crates ä½¿å¾—é¡¹ç›®ç®¡ç†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚
å› æ­¤ï¼Œåœ¨åº•å±‚å¼€å‘ä¸­è¿ç”¨ dev opsï¼Œä¹Ÿä¸æ˜¯ä¸€ä»¶éš¾äº‹äº†ï¼Œæ¯”å¦‚è¯­æ³•æ£€æŸ¥ã€AI å»ºè®®ã€CI/CD è‡ªåŠ¨æ„å»ºã€‚
{% endnotel %}

### ç¤ºä¾‹ä»£ç 

åˆå§‹åŒ– GPIOï¼Œå®Œå…¨ä¸ç”¨æ‰‹å†™å¤æ‚çš„é€»è¾‘ï¼š

```rust
let p = hal::init(hal_config);
let mut led = Output::new(pin, Level::Low, Default::default());
```

å¦‚æœæƒ³è¦è®¾ç½®å¼•è„šï¼Œä¹Ÿå¾ˆç®€å•ï¼ŒOOP ä½¿å¾—ä¸€åˆ‡å˜å¾—ç®€æ´ä¸ç¾è§‚ï¼š

```rust
led.set_high();
led.set_low();
```

## è½¯ä»¶å·¥ç¨‹æ€ç»´

è½¯ä»¶å·¥ç¨‹å……æ–¥ç€é¢å‘å¯¹è±¡å’Œè®¾è®¡æ¨¡å¼ï¼Œå¼€å‘è€…å¯ä»¥å°†ç›¸å…³åŠŸèƒ½å°è£…æˆå¯¹è±¡ï¼Œè®©å•ç‰‡æœºå¼€å‘å˜å¾—ä¸å‰ç«¯å¼€å‘ä¸€æ ·ã€‚

ä»¥ä¸‹ä½¿ç”¨æˆ‘çš„ä¸ªäººé¡¹ç›®[CH32-ST7735-Demo](https://github.com/Yttehs-HDX/CH32-ST7735-Demo)ä¸¾ä¾‹ï¼š

è¿™ä¸ªé¡¹ç›®ç®€å•ä½¿ç”¨äº† ST7735 å±å¹•æ˜¾ç¤ºå›ºå®šçš„å›¾æ¡ˆï¼Œä»¥ä¸‹ä¸¤å¤„è¿›è¡Œäº†å°è£…ï¼š

### æ§åˆ¶æ˜¾ç¤º

- [display_manager.rs](https://github.com/Yttehs-HDX/CH32-ST7735-Demo/blob/main/src/display_manager.rs)

```rust
fn new(dc: AnyPin, rst: AnyPin, cs: AnyPin, spi: Spi<'a, T, M>, display_rgb: bool, display_inverted: bool, display_width: u32, display_height: u32) -> Self
fn init(&mut self)
fn clear(&mut self, color: Rgb565)
fn set_orientation(&mut self, orientation: Orientation)
fn set_offset(&mut self, x: u16, y: u16)
fn draw_image(&mut self, image: &ImageRaw<Rgb565, LittleEndian>)
```

### æ§åˆ¶èƒŒå…‰äº®åº¦

- [backlight_manager.rs](https://github.com/Yttehs-HDX/CH32-ST7735-Demo/blob/main/src/backlight_manager.rs)

```rust
fn new(pwm: SimplePwm<'a, T>, channel: Channel) -> Self
fn enable(&mut self)
fn set_brightness(&mut self, level: BrightnessLevel)
```

å‡½æ•°å†…éƒ¨å°è£…çš„å¯èƒ½æ˜¯å¯¹å¼•è„šçš„ç›´æ¥æ“ä½œï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹å…¶ä»–åº“å‡½æ•°çš„å°è£…ï¼Œå½“ç„¶ï¼Œä½¿ç”¨æ—¶æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒè¿™äº›ã€‚

## ç»“è¯­

ä½¿ç”¨ç¬¬ä¸‰æ–¹ HAL åº“ï¼Œembassy crate è¿›è¡Œå•ç‰‡æœºå¼€å‘ç»™æˆ‘å¸¦æ¥äº†æå¥½çš„ä½“éªŒï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸é€‚ç”¨äºæ¯ä¸€ä¸ªäººï¼Œå› ä¸ºæ¶‰åŠåˆ°äº†æ–°çš„è¯­è¨€ Rustï¼Œå’Œç›¸å…³çš„ CLI åŒ…ç®¡ç†å·¥å…· cargoã€‚

ä¼ä¸šã€å…¬å¸å†…éƒ¨çš„å•ç‰‡æœºå¼€å‘è‚¯å®šä¸ä¼šå†’é£é™©ä½¿ç”¨ç¬¬ä¸‰æ–¹ HAL åº“ï¼Œå¦‚æœç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ä¿è¯ä¸¥æ ¼çš„å®‰å…¨æ€§ï¼Œå°±è€è€å®å®ç”¨å®˜æ–¹åº“å§ã€‚
